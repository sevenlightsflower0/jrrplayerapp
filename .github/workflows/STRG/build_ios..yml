name: Build iOS - Multiple Environments

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

env:
  FLUTTER_VERSION: '3.19.5'

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - environment: development
            flavor: dev
            export_method: development
          - environment: staging
            flavor: staging
            export_method: ad-hoc
          - environment: production
            flavor: prod
            export_method: app-store
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install Dependencies
        run: |
          flutter pub get
          cd ios
          pod install

      - name: Build IPA for ${{ matrix.environment }}
        run: |
          flutter build ipa \
            --flavor ${{ matrix.flavor }} \
            --export-options-plist=ios/ExportOptions-${{ matrix.environment }}.plist

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.environment }}-ipa
          path: build/ios/ipa/*.ipa
          retention-days: 30